<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PhotoBooth Bian</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Pacifico&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Fredoka', sans-serif;
            background: linear-gradient(135deg, #a78bfa 0%, #6366f1 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }
        .strip-font { font-family: 'Pacifico', cursive; }
        
        /* Mirror Video */
        video { transform: scaleX(-1); }
        
        .loader {
            width: 48px; height: 48px;
            border: 5px solid #FFF;
            border-bottom-color: transparent;
            border-radius: 50%;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .flash-active { animation: flash 0.4s ease-out; }
        @keyframes flash {
            0% { opacity: 1; background: white; z-index: 60; position: fixed; inset: 0; }
            100% { opacity: 0; }
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4 md:p-8">

    <div id="flash-layer"></div>

    <div id="loading" class="fixed inset-0 bg-indigo-900/95 z-50 flex flex-col items-center justify-center text-white px-4 text-center">
        <span class="loader mb-6"></span>
        <h2 class="text-3xl font-bold mb-2">PhotoBooth Bian</h2>
        <p class="text-lg opacity-90">Sedang menyiapkan kamera...</p>
    </div>

    <div class="flex flex-col xl:flex-row gap-8 w-full max-w-7xl items-start justify-center">
        
        <div class="w-full xl:flex-1 bg-white/95 backdrop-blur-sm rounded-[2rem] shadow-2xl p-4 md:p-6 flex flex-col gap-4 border-4 border-white/50">
            <div class="flex items-center justify-center gap-3 mb-1">
                <span class="text-4xl">üì∏</span>
                <h1 class="text-3xl md:text-4xl font-bold text-indigo-900 strip-font tracking-wider">PhotoBooth Bian</h1>
            </div>
            <p class="text-center text-gray-500 text-sm mb-2">Otomatis pakai topi, gaya suka-suka!</p>

            <div class="relative w-full aspect-[4/3] bg-gray-900 rounded-2xl overflow-hidden shadow-inner border-[6px] border-indigo-100">
                <video id="webcam" autoplay playsinline muted class="w-full h-full object-cover"></video>
                <canvas id="overlayCanvas" class="absolute inset-0 pointer-events-none hidden"></canvas>
                <div id="video-props-container" class="absolute inset-0 pointer-events-none overflow-hidden"></div>

                <div id="status-badge" class="absolute top-4 left-4 bg-yellow-400/90 backdrop-blur text-black font-bold px-4 py-2 rounded-full text-sm shadow-lg flex items-center gap-2 transition-all z-10">
                    <span class="animate-pulse text-lg">‚óè</span> Memuat Kamera...
                </div>

                <div id="countdown" class="hidden absolute inset-0 flex items-center justify-center bg-black/50 backdrop-blur-md z-30">
                    <span class="text-[10rem] font-bold text-white drop-shadow-[0_5px_15px_rgba(0,0,0,0.5)] animate-bounce">3</span>
                </div>
            </div>

            <div class="bg-indigo-50/80 p-4 rounded-2xl border-2 border-indigo-100">
                <div class="flex justify-center mb-4">
                     <button onclick="setProp('hat')" class="prop-btn ring-4 ring-indigo-500 bg-green-100 hover:bg-green-200 p-4 rounded-2xl hover:scale-105 transition-all shadow-md w-full md:w-1/2 flex flex-col items-center">
                        <div class="text-5xl mb-1 drop-shadow-md">üé©</div>
                        <div class="text-lg font-bold text-gray-800">Topi Pesulap</div>
                        <div class="text-xs text-green-700 font-semibold">Otomatis di Kepala</div>
                    </button>
                </div>

                <div class="text-center mb-4">
                    <button onclick="removeProp()" class="text-red-500 text-sm font-bold hover:text-red-700 hover:underline transition-all flex items-center justify-center gap-1 mx-auto bg-white px-3 py-1 rounded-full shadow-sm">
                        <span>‚ùå</span> Lepas Topi
                    </button>
                </div>

                <button id="btn-capture" onclick="startCaptureSequence()" class="w-full bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 hover:from-indigo-700 hover:to-pink-700 text-white font-bold py-5 rounded-2xl shadow-xl text-xl flex items-center justify-center gap-3 transform active:scale-95 transition-all border-b-4 border-indigo-900 relative overflow-hidden group">
                    <span class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></span>
                    <span class="relative flex items-center gap-2">üì∏ MULAI FOTO (3x)</span>
                </button>
            </div>
        </div>

        <div class="w-full xl:w-auto flex flex-col items-center justify-start shrink-0">
            <div id="photo-strip" class="bg-white p-6 rounded-[2rem] shadow-[0_20px_50px_rgba(0,0,0,0.3)] relative border-8 border-white overflow-hidden" 
                 style="width: 100%; max-width: 340px; min-height: 850px; background-image: radial-gradient(#f3e8ff 10%, transparent 10%); background-size: 20px 20px;">
                
                <div class="absolute top-0 left-0 w-full h-4 bg-gradient-to-r from-indigo-400 to-pink-400"></div>

                <div class="text-center border-b-2 border-dashed border-indigo-200 pb-5 mb-6 relative mt-4">
                    <div class="text-indigo-300 text-2xl absolute top-0 left-4 animate-pulse">‚ú®</div>
                    <div class="text-pink-300 text-2xl absolute top-2 right-4 animate-pulse delay-150">‚≠ê</div>
                    <h2 class="strip-font text-4xl text-indigo-900 drop-shadow-sm">PhotoBooth Bian</h2>
                    <p class="text-sm font-semibold text-pink-600 tracking-widest uppercase mt-1">‚òÖ Edisi Spesial ‚òÖ</p>
                    <p class="text-[10px] text-gray-500 tracking-wider mt-2 bg-white inline-block px-3 py-1 rounded-full shadow-sm" id="date-display">DATE: -</p>
                </div>

                <div id="results-container" class="flex flex-col gap-5 relative z-10">
                    <div class="aspect-[4/3] bg-indigo-50 rounded-xl flex flex-col items-center justify-center text-indigo-200 border-4 border-dashed border-indigo-200 shadow-inner group hover:border-indigo-300 transition-all">
                        <span class="text-5xl group-hover:scale-110 transition-transform">1</span>
                        <span class="text-xs mt-2 font-semibold">Pose Satu!</span>
                    </div>
                    <div class="text-center text-indigo-300 text-xl leading-none opacity-50">‚ú¶ ‚ú¶ ‚ú¶</div>
                    
                    <div class="aspect-[4/3] bg-purple-50 rounded-xl flex flex-col items-center justify-center text-purple-200 border-4 border-dashed border-purple-200 shadow-inner group hover:border-purple-300 transition-all">
                        <span class="text-5xl group-hover:scale-110 transition-transform">2</span>
                         <span class="text-xs mt-2 font-semibold">Gaya Bebas!</span>
                    </div>
                    <div class="text-center text-purple-300 text-xl leading-none opacity-50">‚ú¶ ‚ú¶ ‚ú¶</div>

                    <div class="aspect-[4/3] bg-pink-50 rounded-xl flex flex-col items-center justify-center text-pink-200 border-4 border-dashed border-pink-200 shadow-inner group hover:border-pink-300 transition-all">
                        <span class="text-5xl group-hover:scale-110 transition-transform">3</span>
                         <span class="text-xs mt-2 font-semibold">Senyum Terbaik!</span>
                    </div>
                </div>

                <div class="mt-8 text-center relative border-t-2 border-dashed border-indigo-200 pt-5">
                     <div class="text-yellow-400 text-xl absolute -top-3 left-1/2 -translate-x-1/2 bg-white px-2">‚ú® ‚≠ê ‚ú®</div>
                    <h3 class="font-bold text-indigo-900 tracking-[0.2em] uppercase text-sm">Kenangan Indah</h3>
                    <p class="text-xs text-gray-500 mt-1 strip-font">~ captured by bian ~</p>
                </div>

                 <div class="absolute bottom-0 left-0 w-full h-4 bg-gradient-to-r from-pink-400 to-indigo-400"></div>
            </div>

            <button id="btn-download" onclick="downloadImage()" class="mt-6 w-full max-w-[340px] bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-4 rounded-2xl font-bold shadow-xl hidden flex items-center justify-center gap-2 hover:-translate-y-1 transition-all border-b-4 border-indigo-900">
                üì• Simpan Strip Foto
            </button>
        </div>
    </div>

    <script>
        const VIDEO_SIZE = { width: 640, height: 480 };

        /* DATABASE PROPS - TUNING AKHIR
           - scale: 1.0 (Lebih kecil dari 1.1)
           - xOffset: 0 (Geser ke KIRI dari posisi sebelumnya -15)
        */
        const PROPS_DB = {
            'hat': { 
                emoji: 'üé©', 
                type: 'head', 
                baseSize: 160, 
                scale: 1.0,          // <-- UKURAN LEBIH KECIL
                yOffsetFactor: -0.35, 
                xOffset: 0           // <-- GESER KE KIRI (Nol = tengah relatif)
            }
        };

        let currentProp = 'hat'; 
        let videoEl, canvasEl, propsContainer;
        let isStreamReady = false;
        let lastDetection = null;

        async function init() {
            videoEl = document.getElementById('webcam');
            canvasEl = document.getElementById('overlayCanvas');
            propsContainer = document.getElementById('video-props-container');

            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('date-display').innerText = `${now.toLocaleDateString('id-ID', options)} | ${now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;

            try {
                await faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/');
                await faceapi.nets.faceLandmark68Net.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/');

                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: VIDEO_SIZE.width }, 
                        height: { ideal: VIDEO_SIZE.height },
                        facingMode: 'user' 
                    } 
                });
                videoEl.srcObject = stream;
                
                videoEl.onloadedmetadata = () => {
                    videoEl.play();
                    document.getElementById('loading').style.display = 'none';
                    isStreamReady = true;
                    startDetectionLoop();
                    setProp('hat'); 
                };
            } catch (err) {
                console.error(err);
                document.getElementById('loading').innerHTML = `
                    <div class="bg-red-100 p-4 rounded-xl text-red-800 max-w-sm mx-auto">
                        <h3 class="font-bold text-lg mb-2">Gagal Memuat!</h3>
                        <p class="text-sm">${err.message}</p>
                    </div>
                `;
            }
        }

        async function startDetectionLoop() {
            const displaySize = { width: videoEl.clientWidth, height: videoEl.clientHeight };
            faceapi.matchDimensions(canvasEl, displaySize);
            
            const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 160, scoreThreshold: 0.4 });

            setInterval(async () => {
                if (!isStreamReady || videoEl.paused || videoEl.ended) return;

                const detection = await faceapi.detectSingleFace(videoEl, options).withFaceLandmarks();
                const badge = document.getElementById('status-badge');

                if (detection) {
                    badge.innerHTML = `<span class="text-green-600 text-xl">‚ò∫</span> <span class="text-green-800">Siap Foto!</span>`;
                    badge.classList.replace('bg-yellow-400/90', 'bg-green-300/90');
                    
                    const resized = faceapi.resizeResults(detection, { width: videoEl.clientWidth, height: videoEl.clientHeight });
                    lastDetection = resized;
                    
                    if (currentProp) updatePropPosition(resized);
                } else {
                    badge.innerHTML = `<span class="animate-pulse text-xl">ü§î</span> <span class="text-yellow-900">Mana wajahnya?</span>`;
                    badge.classList.replace('bg-green-300/90', 'bg-yellow-400/90');
                    lastDetection = null;
                    clearPropVisual();
                }
            }, 100); 
        }

        function updatePropPosition(detection) {
            const data = PROPS_DB[currentProp];
            if (!data) return;

            const box = detection.detection.box;
            let x, y, rotation = 0;
            const baseFaceWidthRef = 150; 
            const size = data.baseSize * (box.width / baseFaceWidthRef) * data.scale;

            x = box.x + (box.width / 2); 
            y = box.y + (size * data.yOffsetFactor); 

            if (data.xOffset) x += data.xOffset;

            const currentVideoWidth = videoEl.clientWidth;
            const mirroredX = currentVideoWidth - x;

            renderProp(mirroredX, y, size, -rotation, data.emoji);
        }

        function renderProp(x, y, size, rot, emoji) {
            let el = document.getElementById('active-prop-el');
            if (!el) {
                el = document.createElement('div');
                el.id = 'active-prop-el';
                el.className = 'absolute flex items-center justify-center pointer-events-none drop-shadow-[0_5px_5px_rgba(0,0,0,0.3)]'; 
                el.style.transformOrigin = "center center";
                el.style.lineHeight = "1";
                el.style.transition = "all 0.05s ease-out";
                propsContainer.appendChild(el);
            }
            
            el.innerText = emoji;
            el.style.fontSize = `${size}px`;
            el.style.width = `${size}px`;
            el.style.height = `${size}px`;
            el.style.left = `${x - (size/2)}px`;
            el.style.top = `${y - (size/2)}px`;
            el.style.transform = `rotate(${rot}deg)`;
            el.style.opacity = 1;
        }

        function clearPropVisual() {
            const el = document.getElementById('active-prop-el');
            if (el) el.style.opacity = 0;
        }

        function setProp(key) {
            if (!PROPS_DB[key]) return;
            currentProp = key;
            const btn = document.querySelector(`button[onclick="setProp('${key}')"]`);
            if(btn) {
                btn.classList.add('ring-4', 'ring-indigo-500', 'scale-105');
                setTimeout(() => btn.classList.remove('scale-105'), 200);
            }
        }

        function removeProp() {
            currentProp = null;
            clearPropVisual();
            document.querySelectorAll('.prop-btn').forEach(btn => btn.classList.remove('ring-4', 'ring-indigo-500'));
        }

        async function startCaptureSequence() {
            if (!lastDetection && currentProp) {
                alert("Wajah tidak terdeteksi!");
                return;
            }
            
            const btn = document.getElementById('btn-capture');
            const countdownEl = document.getElementById('countdown');
            const resultContainer = document.getElementById('results-container');
            const flash = document.getElementById('flash-layer');
            const downloadBtn = document.getElementById('btn-download');

            btn.disabled = true;
            btn.innerHTML = `<span class="animate-spin text-2xl">‚è≥</span> <span class="text-lg">Siap-siap...</span>`;
            btn.classList.add('opacity-75', 'cursor-not-allowed');
            resultContainer.innerHTML = ''; 
            downloadBtn.classList.add('hidden');

            for (let i = 1; i <= 3; i++) {
                countdownEl.classList.remove('hidden');
                const countSpan = countdownEl.querySelector('span');
                for (let c = 3; c > 0; c--) {
                    countSpan.innerText = c;
                    countSpan.classList.remove('animate-bounce');
                    void countSpan.offsetWidth; 
                    countSpan.classList.add('animate-bounce');
                    await wait(900);
                }
                countdownEl.classList.add('hidden');

                flash.classList.add('flash-active');
                setTimeout(() => flash.classList.remove('flash-active'), 400);

                const imgData = await captureFrame(i);
                
                const div = document.createElement('div');
                div.className = "aspect-[4/3] bg-white rounded-xl overflow-hidden border-[6px] border-white shadow-lg relative group rotate-1 transition-transform hover:rotate-0";
                if (i % 2 === 0) div.classList.replace('rotate-1', '-rotate-1');
                
                div.innerHTML = `
                    <img src="${imgData}" class="w-full h-full object-cover">
                    <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-2 flex justify-between items-end opacity-0 group-hover:opacity-100 transition-opacity">
                        <span class="text-white font-bold text-sm">Foto #${i}</span>
                        <span class="text-yellow-300 text-xs">‚ú® Bian's Booth</span>
                    </div>
                `;
                resultContainer.appendChild(div);

                if (i < 3) {
                    const divider = document.createElement('div');
                    divider.className = "text-center text-indigo-300 text-xl leading-none opacity-50 py-1";
                    divider.innerHTML = i % 2 !== 0 ? "‚ú¶ ‚ú¶ ‚ú¶" : "‚Ä¢ ‚Ä¢ ‚Ä¢";
                    resultContainer.appendChild(divider);
                }

                if (i < 3) await wait(1500);
            }

            btn.disabled = false;
            btn.innerHTML = `<span class="text-xl">üîÑ</span> AMBIL ULANG`;
            btn.classList.remove('opacity-75', 'cursor-not-allowed');
            downloadBtn.classList.remove('hidden');
            downloadBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function captureFrame(photoNum) {
            const canvas = document.createElement('canvas');
            canvas.width = videoEl.videoWidth;
            canvas.height = videoEl.videoHeight;
            const ctx = canvas.getContext('2d');

            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(videoEl, 0, 0);

            if (currentProp && lastDetection) {
                const propEl = document.getElementById('active-prop-el');
                if (propEl && propEl.style.opacity != '0') {
                    ctx.setTransform(1, 0, 0, 1, 0, 0);

                    const propRect = propEl.getBoundingClientRect();
                    const videoRect = videoEl.getBoundingClientRect();

                    const scaleX = canvas.width / videoRect.width;
                    const scaleY = canvas.height / videoRect.height;

                    const x = (propRect.left - videoRect.left) * scaleX + (propRect.width * scaleX / 2);
                    const y = (propRect.top - videoRect.top) * scaleY + (propRect.height * scaleY / 2);
                    const fontSize = parseFloat(window.getComputedStyle(propEl).fontSize) * scaleX;
                    
                    let rotation = 0;
                    if(propEl.style.transform.includes('rotate')) {
                        rotation = parseFloat(propEl.style.transform.replace(/[^\d.-]/g, '')) * (Math.PI / 180);
                    }

                    ctx.translate(x, y);
                    ctx.rotate(rotation);
                    ctx.shadowColor = "rgba(0,0,0,0.4)";
                    ctx.shadowBlur = 15 * scaleX;
                    ctx.shadowOffsetY = 5 * scaleY;
                    
                    ctx.font = `${fontSize}px "Segoe UI Emoji", "Apple Color Emoji", sans-serif`; 
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(propEl.innerText, 0, 0);
                }
            }
            return canvas.toDataURL('image/jpeg', 0.95); 
        }

        function downloadImage() {
            const stripElement = document.getElementById('photo-strip');
            const btn = document.getElementById('btn-download');
            
            btn.disabled = true;
            btn.innerHTML = `‚è≥ Sedang Menyimpan...`;

            const options = {
                scale: 3, 
                useCORS: true, 
                allowTaint: true,
                backgroundColor: null,
                logging: false,
                onclone: (clonedDoc) => {
                    const clonedStrip = clonedDoc.getElementById('photo-strip');
                    clonedStrip.style.width = '340px'; 
                    clonedStrip.style.maxWidth = 'none';
                    clonedStrip.style.height = 'auto';
                }
            };

            html2canvas(stripElement, options).then(canvas => {
                const link = document.createElement('a');
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                link.download = `Bian-PhotoStrip-${timestamp}.png`;
                link.href = canvas.toDataURL('image/png');
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                btn.disabled = false;
                btn.innerHTML = `üì• Simpan Strip Foto`;
            }).catch(err => {
                 console.error("Gagal download:", err);
                 alert("Maaf, gagal menyimpan foto. Silakan coba lagi.");
                 btn.disabled = false;
                 btn.innerHTML = `üì• Simpan Strip Foto`;
            });
        }

        const wait = (ms) => new Promise(r => setTimeout(r, ms));
        init();
    </script>
</body>
</html>